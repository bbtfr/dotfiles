#!/usr/bin/env python3

import os
import shlex
import subprocess
import sys
from argparse import ArgumentParser
from configparser import ConfigParser

ANYCONNECT_CONF_PATH = os.path.expanduser("~/.config/anyconnect/anyconnect.conf")
ANYCONNECT_APP_NAME = "Cisco AnyConnect Secure Mobility Client"
ANYCONNECT_APP_PATH = "/Applications/Cisco/%s.app" % ANYCONNECT_APP_NAME
ANYCONNECT_CLI_PATH = "/opt/cisco/anyconnect/bin/vpn"


def cli():
    pass


def run_command(commands, check=True, shell=True, ignore_errors=[], **kwargs):
    print("Run Command:", commands if shell else shlex.join(commands), file=sys.stderr)
    proc = subprocess.run(commands, shell=shell, **kwargs)
    if not check or not proc.returncode:
        return proc
    if proc.stderr is not None:
        for error in ignore_errors:
            if error.encode() in proc.stderr:
                return proc
        sys.stderr.buffer.write(proc.stderr)
    sys.exit(proc.returncode)


def load_anyconnect_config(server_name=None):
    parser = ConfigParser()
    parser.read(ANYCONNECT_CONF_PATH)
    if server_name is not None:
        return dict(parser[server_name])
    return parser


def connect(server_name):
    run_command(
        'pkill -x "%s"' % ANYCONNECT_APP_NAME,
        check=False,
    )

    server_info = load_anyconnect_config(server_name)
    run_command(
        'echo "%s\n%s\n%s\n" | %s -s connect %s'
        % (
            server_info["group"],
            server_info["user"],
            server_info["pass"],
            ANYCONNECT_CLI_PATH,
            server_info["host"],
        ),
    )
    run_command(
        'open "%s"' % ANYCONNECT_APP_PATH,
        ignore_errors=["Canâ€™t continue open. (-1708)"],
    )


if __name__ == "__main__":
    # create the top-level parser
    parser = ArgumentParser(prog="xcisco")
    subparsers = parser.add_subparsers()

    # create the parser for the "connect" command
    parser_connect = subparsers.add_parser("connect", help="Connect to MegVPN server")
    parser_connect.add_argument("server_name", help="Server name")
    parser_connect.set_defaults(func=connect)

    args = parser.parse_args()
    kwargs = dict(args._get_kwargs())
    func = kwargs.pop("func")
    func(**kwargs)
